<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Heroes</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение шрифта Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Иконки Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .points-popup {
            position: absolute; bottom: 110%; left: 50%;
            transform: translateX(-50%); padding: 4px 12px;
            border-radius: 9999px; font-weight: bold; color: white;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes floatUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -60px); }
        }
        .tab-active { background-color: #4f46e5; color: white; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; animation: fadeIn 0.3s ease;
        }
        .modal-content {
            animation: fadeIn 0.3s ease, slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(20px) scale(0.95); }
            to { transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Экраны приложения -->
    <div id="loading-screen" class="text-center">
        <h1 class="text-3xl font-bold text-indigo-400">Sales Heroes</h1>
        <p class="text-slate-400 mt-2">Загрузка данных...</p>
    </div>

    <div id="auth-screen" class="hidden bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 fade-in">
        <!-- Форма будет меняться между входом и регистрацией -->
    </div>

    <div id="app-container" class="hidden w-full max-w-4xl mx-auto fade-in">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 id="user-nickname" class="text-3xl font-bold text-white"></h1>
                    <div class="flex items-center mt-1">
                        <p id="user-team" class="text-indigo-400 font-medium"></p>
                        <p id="user-title" class="ml-4 text-amber-400 font-semibold text-sm bg-amber-400/10 px-2 py-0.5 rounded"></p>
                    </div>
                </div>
                 <div class="flex items-center space-x-4">
                    <div class="text-right">
                         <p class="text-sm text-slate-400">Баланс</p>
                         <p id="header-balance" class="text-lg font-bold text-green-400 flex items-center">
                            <ion-icon name="cash-outline" class="mr-1"></ion-icon>
                            <span></span>
                        </p>
                    </div>
                    <button id="logout-button" class="bg-slate-700 hover:bg-red-600 hover:text-white text-slate-300 font-bold py-2 px-3 rounded-lg transition-colors">Выйти</button>
                </div>
            </div>
            <div class="mb-6">
                <div id="tabs-container" class="flex bg-slate-700 rounded-lg p-1">
                    <button id="tab-chat" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Чат</button>
                    <button id="tab-feed" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Лента</button>
                    <button id="tab-dashboard" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Панель</button>
                    <button id="tab-ratings" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Рейтинги</button>
                    <button id="tab-shop" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Магазин</button>
                    <button id="tab-admin" class="hidden w-full py-2 rounded-md text-sm font-medium transition-colors">Админ</button>
                </div>
            </div>
            <!-- Контент вкладок -->
            <div id="chat-content" class="hidden">
                <div class="flex justify-center mb-4">
                     <div class="flex bg-slate-600 rounded-lg p-1">
                        <button id="chat-type-global" class="px-4 py-1 rounded-md text-sm font-medium transition-colors">Общий</button>
                        <button id="chat-type-team" class="px-4 py-1 rounded-md text-sm font-medium transition-colors">Командный</button>
                    </div>
                </div>
                <div id="chat-messages" class="bg-slate-900/50 p-4 rounded-lg h-80 overflow-y-auto flex flex-col-reverse"></div>
                <form id="chat-form" class="mt-4 flex gap-4">
                    <input type="text" id="chat-input" class="flex-grow bg-slate-700 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Введите ваше сообщение..." required>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg flex items-center"><ion-icon name="send-outline"></ion-icon></button>
                </form>
            </div>
            <div id="feed-content" class="hidden">
                 <h2 class="text-xl font-bold mb-4 text-center">Лента событий</h2>
                 <ul id="event-feed-list" class="space-y-3 max-h-[450px] overflow-y-auto pr-2"></ul>
            </div>
            <div id="dashboard-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Ранг</p><p id="user-rank" class="text-2xl font-semibold text-white"></p></div>
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Баланс</p><p id="user-balance" class="text-2xl font-semibold text-green-400"></p></div>
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Всего очков</p><p id="user-total-points" class="text-2xl font-semibold text-white"></p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="add-zalog" class="relative bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform hover:scale-105">Закрыть Залог <span class="block text-sm opacity-80">+100 очков</span></button>
                    <button id="add-pochta" class="relative bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform hover:scale-105">Почтовые сборы <span class="block text-sm opacity-80">+20 очков</span></button>
                </div>
            </div>
            <div id="ratings-content" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div><h2 class="text-xl font-bold mb-4 text-center">Личный рейтинг</h2><ul id="personal-rating-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></ul></div>
                    <div><h2 class="text-xl font-bold mb-4 text-center">Командный рейтинг</h2><ul id="team-rating-list" class="space-y-3"></ul></div>
                 </div>
            </div>
            <div id="shop-content" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Магазин призов</h2>
                <div id="shop-items-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="admin-content" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Панель Администратора</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Управление магазином</h3>
                        <div id="admin-shop-list" class="space-y-2 mb-4"></div>
                        <form id="add-item-form" class="bg-slate-700/50 p-4 rounded-lg space-y-3">
                             <h4 class="font-semibold">Добавить новый товар</h4>
                             <input type="text" id="item-name" placeholder="Название" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="text" id="item-desc" placeholder="Описание" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="number" id="item-price" placeholder="Цена" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="text" id="item-icon" placeholder="Иконка (напр. cafe-outline)" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5">
                             <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg py-2">Добавить товар</button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Управление пользователями</h3>
                        <div id="admin-user-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                         <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">Управление игрой</h3>
                            <button id="reset-game-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Сбросить всю игру</button>
                            <p class="text-xs text-slate-400 mt-2">ВНИМАНИЕ: Это действие удалит все пользователей и их прогресс без возможности восстановления.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="rank-up-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-2 border-indigo-500 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-amber-400 mb-2">НОВЫЙ РАНГ!</h2>
            <p class="text-slate-300 mb-4">Вы достигли ранга:</p>
            <p id="new-rank-name" class="text-4xl font-bold text-white bg-indigo-600 rounded-lg py-3 mb-6"></p>
            <button id="close-rank-modal" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Продолжить</button>
        </div>
    </div>
    <div id="achievement-unlocked-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-2 border-amber-500 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-amber-400 mb-2">ДОСТИЖЕНИЕ РАЗБЛОКИРОВАНО!</h2>
            <p id="achievement-name" class="text-3xl font-bold text-white mb-2"></p>
            <p id="achievement-desc" class="text-slate-300 mb-6"></p>
            <button id="close-achievement-modal" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Отлично!</button>
        </div>
    </div>
    <div id="purchase-confirm-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-white mb-2">Подтверждение покупки</h2>
            <p id="purchase-confirm-text" class="text-slate-300 mb-6"></p>
            <div class="flex justify-between gap-4">
                <button id="cancel-purchase-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Отмена</button>
                <button id="confirm-purchase-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg py-2.5">Купить</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
             <p id="alert-modal-text" class="text-white text-lg mb-6"></p>
             <button id="close-alert-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg py-2.5">Понятно</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, updateDoc, increment, onSnapshot, collection, query, orderBy, addDoc, writeBatch, getDocs, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // <!-- ВАЖНО: Вставьте сюда конфигурацию вашего проекта Firebase -->
        const firebaseConfig = {
            apiKey: "AIzaSyBqnRUwI3kJPWzHFAdHc9FIB1TAXtE5vgQ",
            authDomain: "gamemanager-52afb.firebaseapp.com",
            projectId: "gamemanager-52afb",
            storageBucket: "gamemanager-52afb.appspot.com",
            messagingSenderId: "525819683229",
            appId: "1:525819683229:web:023499db2fc65e9476cf74"
        };
        // <!-- Конец секции конфигурации -->

        // <!-- ВАЖНО: Вставьте сюда UID вашего администратора -->
        const ADMIN_UID = "zVLBmTTWPnPT6dBAnwsoSDglCHB3";
        // <!-- Конец секции UID -->
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const dom = Object.fromEntries(['loading-screen', 'auth-screen', 'app-container', 'logout-button', 'add-zalog', 'add-pochta', 'tabs-container', 'tab-chat','tab-feed', 'tab-dashboard', 'tab-ratings', 'tab-shop', 'tab-admin', 'chat-content', 'feed-content', 'dashboard-content', 'ratings-content', 'shop-content', 'admin-content', 'rank-up-modal', 'close-rank-modal', 'new-rank-name', 'purchase-confirm-modal', 'purchase-confirm-text', 'cancel-purchase-btn', 'confirm-purchase-btn', 'alert-modal', 'alert-modal-text', 'close-alert-modal', 'user-nickname', 'user-team', 'header-balance', 'user-rank', 'user-balance', 'user-total-points', 'personal-rating-list', 'team-rating-list', 'shop-items-grid', 'admin-shop-list', 'add-item-form', 'admin-user-list', 'reset-game-btn', 'user-title', 'achievement-unlocked-modal', 'achievement-name', 'achievement-desc', 'close-achievement-modal', 'event-feed-list', 'chat-type-global', 'chat-type-team', 'chat-messages', 'chat-form', 'chat-input'].map(id => [id.replace(/-/g, ''), document.getElementById(id)]));

        const RANKS = [
            { name: "Новичок", points: 0 }, { name: "Специалист", points: 1000 }, { name: "Эксперт", points: 5000 },
            { name: "Мастер", points: 15000 }, { name: "Легенда продаж", points: 30000 }
        ];

        const ACHIEVEMENTS = {
            ZALOG_KING: { name: "Король Залогов", description: "Закройте 10 залогов.", condition: (user) => user.zalogCount >= 10 },
            POCHTA_MASTER: { name: "Мастер Сборов", description: "Закройте 50 почтовых сборов.", condition: (user) => user.pochtaCount >= 50 },
            SHOPAHOLIC: { name: "Коллекционер", description: "Совершите 3 покупки в магазине.", condition: async (user) => {
                const purchasesSnap = await getDocs(collection(db, `users_private/${user.uid}/purchases`));
                return purchasesSnap.size >= 3;
            }},
            SPRINTER: { name: "Спринтер", description: "Первым наберите 1000 очков.", condition: async (user) => {
                if (user.totalPoints < 1000) return false;
                const globalDoc = await getDoc(doc(db, 'global', 'gameState'));
                return !globalDoc.data()?.sprinterAwarded;
            }}
        };

        let unsubscribers = [];
        let currentUser = null;
        let currentChatType = 'global';

        function renderAuthForm(isLogin = true) {
            dom.authscreen.innerHTML = `
                <h1 class="text-3xl font-bold text-center mb-2 text-indigo-400">${isLogin ? 'Вход' : 'Регистрация'}</h1>
                <p class="text-center text-slate-400 mb-6">${isLogin ? 'Введите ваши данные для входа' : 'Создайте новый аккаунт'}</p>
                <form id="auth-form" class="space-y-4">
                    ${!isLogin ? `
                    <div>
                        <label for="nickname" class="block mb-2 text-sm font-medium">Никнейм</label>
                        <input type="text" id="nickname" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                    </div>
                    <div>
                        <label for="team" class="block mb-2 text-sm font-medium">Команда</label>
                        <select id="team" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                             <option value="" disabled selected>-- Ваша команда --</option>
                             <option value="Альфа">Команда "Альфа"</option>
                             <option value="Браво">Команда "Браво"</option>
                             <option value="Чарли">Команда "Чарли"</option>
                             <option value="Дельта">Команда "Дельта"</option>
                        </select>
                    </div>` : ''}
                    <div>
                        <label for="email" class="block mb-2 text-sm font-medium">Email</label>
                        <input type="email" id="email" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                    </div>
                    <div>
                        <label for="password" class="block mb-2 text-sm font-medium">Пароль</label>
                        <input type="password" id="password" class="bg-slate-700 w-full p-2.5 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg">${isLogin ? 'Войти' : 'Создать аккаунт'}</button>
                </form>
                <div class="text-center mt-4 text-sm">
                    <button id="toggle-auth-mode" class="text-indigo-400 hover:underline">
                        ${isLogin ? 'У меня нет аккаунта' : 'Уже есть аккаунт'}
                    </button>
                </div>
            `;
            document.getElementById('auth-form').addEventListener('submit', isLogin ? handleLogin : handleRegister);
            document.getElementById('toggle-auth-mode').addEventListener('click', () => renderAuthForm(!isLogin));
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const { nickname, team, email, password } = form.elements;
            
            form.querySelector('button').disabled = true;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
                const user = userCredential.user;
                const isAdmin = user.uid === ADMIN_UID;
                const batch = writeBatch(db);

                const publicProfile = {
                    uid: user.uid,
                    nickname: isAdmin ? 'Admin' : nickname.value,
                    team: isAdmin ? 'Администрация' : team.value,
                    totalPoints: 0,
                    rank: isAdmin ? "Всемогущий" : "Новичок",
                    equippedTitle: null,
                    createdAt: serverTimestamp(),
                    isAdmin: isAdmin
                };
                const privateProfile = {
                    balance: 0, zalogCount: 0, pochtaCount: 0, unlockedAchievements: []
                };

                batch.set(doc(db, "users_public", user.uid), publicProfile);
                batch.set(doc(db, "users_private", user.uid), privateProfile);
                
                await addLogEntry(`Новый игрок в команде! **${publicProfile.nickname}** присоединился к нам.`, 'person-add-outline');
                await batch.commit();
            } catch (error) {
                showAlert(error.message);
            } finally {
                form.querySelector('button').disabled = false;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const { email, password } = form.elements;
            form.querySelector('button').disabled = true;
            try {
                await signInWithEmailAndPassword(auth, email.value, password.value);
            } catch (error) {
                showAlert(error.message);
            } finally {
                 form.querySelector('button').disabled = false;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            currentUser = null;

            if (user) {
                showLoadingScreen();
                try {
                    const publicDocRef = doc(db, "users_public", user.uid);
                    const privateDocRef = doc(db, "users_private", user.uid);
                    
                    const [publicSnap, privateSnap] = await Promise.all([
                        getDoc(publicDocRef),
                        getDoc(privateDocRef)
                    ]);

                    if (!publicSnap.exists() || !privateSnap.exists()) {
                        await signOut(auth);
                        showAlert("Ошибка данных профиля. Пожалуйста, выйдите и зарегистрируйтесь заново.");
                        return;
                    }

                    currentUser = { uid: user.uid, ...publicSnap.data(), ...privateSnap.data() };
                    
                    const unsubPublic = onSnapshot(publicDocRef, (docSnap) => {
                        currentUser = { ...currentUser, ...docSnap.data() };
                        updateUI();
                    });
                    const unsubPrivate = onSnapshot(privateDocRef, (docSnap) => {
                        currentUser = { ...currentUser, ...docSnap.data() };
                        updateUI();
                    });
                    
                    const unsubEvents = onSnapshot(query(collection(db, "eventLog"), orderBy("timestamp", "desc")), snap => renderEventFeed(snap.docs.map(d=>d.data())));
                    const unsubAllUsers = onSnapshot(query(collection(db, "users_public"), orderBy("totalPoints", "desc")), snap => updateRatingsUI(snap.docs.map(d=>d.data()), user.uid));
                    const unsubShop = onSnapshot(query(collection(db, "shopItems"), orderBy("price")), snap => renderShopItems(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                    const unsubGlobalChat = onSnapshot(query(collection(db, "global_chat"), orderBy("timestamp", "desc")), snap => {
                        if (currentChatType === 'global') renderChatMessages(snap.docs.map(d=>d.data()));
                    });
                    
                    unsubscribers.push(unsubPublic, unsubPrivate, unsubEvents, unsubAllUsers, unsubShop, unsubGlobalChat);

                    if (currentUser.team) {
                         const unsubTeamChat = onSnapshot(query(collection(db, `team_chats/${currentUser.team}/messages`), orderBy("timestamp", "desc")), snap => {
                            if (currentChatType === 'team') renderChatMessages(snap.docs.map(d=>d.data()));
                        });
                        unsubscribers.push(unsubTeamChat);
                    }
                    
                    updateUI();
                    showAppContainer();
                    
                    const shopCheck = await getDocs(collection(db, "shopItems"));
                    if(shopCheck.empty) setupInitialShopItems();

                } catch (error) {
                    console.error("Ошибка загрузки данных: ", error);
                    showAlert("Не удалось загрузить данные профиля.");
                    signOut(auth);
                }
            } else {
                showAuthScreen();
            }
        });

        function updateUI() {
            if (!currentUser?.nickname) return;
            checkAllAchievements();
            
            const { nickname, team, equippedTitle, rank, totalPoints, balance, isAdmin } = currentUser;
            const balanceFormatted = (balance || 0).toLocaleString('ru-RU');

            dom.tabadmin.classList.toggle('hidden', !isAdmin);
            dom.usernickname.textContent = nickname;
            dom.userteam.textContent = `Команда "${team}"`;
            dom.usertitle.textContent = equippedTitle || '';
            dom.usertitle.classList.toggle('hidden', !equippedTitle);
            dom.headerbalance.querySelector('span').textContent = balanceFormatted;
            dom.userrank.textContent = rank;
            dom.userbalance.textContent = balanceFormatted;
            dom.usertotalpoints.textContent = (totalPoints || 0).toLocaleString('ru-RU');
        }

        async function addPoints(points, counterField) {
            if (!auth.currentUser || !currentUser || currentUser.isAdmin) return;
            const publicRef = doc(db, "users_public", auth.currentUser.uid);
            const privateRef = doc(db, "users_private", auth.currentUser.uid);
            
            const batch = writeBatch(db);
            batch.update(publicRef, { totalPoints: increment(points) });
            batch.update(privateRef, { balance: increment(points), [counterField]: increment(1) });
            
            const logMessage = points === 100 
                ? `**${currentUser.nickname}** закрыл **Залог** (+100 очков).`
                : `**${currentUser.nickname}** обработал **Почтовые сборы** (+20 очков).`;
            const logIcon = points === 100 ? 'shield-checkmark-outline' : 'mail-outline';
            addLogEntry(logMessage, logIcon);
            
            await batch.commit();
        }

        async function handlePurchase(item) {
            if (!auth.currentUser || !currentUser || currentUser.balance < item.price) return showAlert("Недостаточно средств!");
            dom.purchaseconfirmmodal.classList.add('hidden');

            const privateRef = doc(db, "users_private", auth.currentUser.uid);
            const batch = writeBatch(db);
            batch.update(privateRef, { balance: increment(-item.price) });
            batch.set(doc(collection(privateRef, 'purchases')), {
                itemId: item.id, itemName: item.name, price: item.price, purchasedAt: serverTimestamp()
            });
            
            await addLogEntry(`**${currentUser.nickname}** купил **${item.name}** в магазине.`, 'bag-handle-outline');
            await batch.commit();
        }
        
        async function checkAllAchievements() {
            if (!currentUser || currentUser.isAdmin) return;
            for (const key in ACHIEVEMENTS) {
                if (!currentUser.unlockedAchievements?.includes(key)) {
                    if (await ACHIEVEMENTS[key].condition(currentUser)) {
                        const achievement = ACHIEVEMENTS[key];
                        const privateRef = doc(db, "users_private", currentUser.uid);
                        const publicRef = doc(db, "users_public", currentUser.uid);
                        
                        const batch = writeBatch(db);
                        batch.update(privateRef, { unlockedAchievements: arrayUnion(key) });
                        batch.update(publicRef, { equippedTitle: achievement.name });
                        
                        addLogEntry(`**${currentUser.nickname}** получил достижение: **${achievement.name}**!`, 'star-outline');
                        showAchievementUnlockedModal(achievement);

                        if (key === 'SPRINTER') {
                            await setDoc(doc(db, 'global', 'gameState'), { sprinterAwarded: true }, { merge: true });
                        }
                        await batch.commit();
                    }
                }
            }
        }
        
        async function setupInitialShopItems() {
            const initialItems = [
                { id: 'item1', name: "Фирменная кружка", description: "Для самого вкусного кофе.", price: 500, icon: "cafe-outline" },
                { id: 'item2', name: "Билет в кино", description: "На любой фильм в любое время.", price: 1500, icon: "film-outline" },
                { id: 'item3', name: "Пицца для отдела", description: "Разделите радость с коллегами.", price: 3000, icon: "pizza-outline" },
                { id: 'item4', name: "Дополнительный выходной", description: "Заслуженный отдых.", price: 10000, icon: "sunny-outline" },
                { id: 'item5', name: "Сертификат в ресторан", description: "На романтический ужин.", price: 7500, icon: "restaurant-outline"},
                { id: 'item6', name: "Наушники", description: "Для работы и отдыха.", price: 12000, icon: "headset-outline"}
            ];
            const batch = writeBatch(db);
            initialItems.forEach(item => {
                batch.set(doc(db, "shopItems", item.id), item);
            });
            await batch.commit();
            console.log("Начальные товары добавлены в магазин.");
        }

        function renderEventFeed(eventLog = []) { dom.eventfeedlist.innerHTML = ''; eventLog.forEach(log => { const timeAgo = formatTimeAgo(log.timestamp?.toDate()); const messageHTML = log.message.replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-400 font-semibold">$1</strong>'); dom.eventfeedlist.innerHTML += `<li class="flex items-start p-3 bg-slate-700/50 rounded-lg"><ion-icon name="${log.icon}" class="text-xl text-slate-400 mr-4 mt-1"></ion-icon><div><p class="text-white">${messageHTML}</p><p class="text-xs text-slate-500 mt-1">${timeAgo}</p></div></li>`; }); }
        async function addLogEntry(message, icon) { try { await addDoc(collection(db, "eventLog"), { message, icon, timestamp: serverTimestamp() }); } catch (error) { console.error("Ошибка добавления в лог:", error); } }
        function switchChatType(type) { currentChatType = type; dom.chattypeglobal.classList.toggle('tab-active', type === 'global'); dom.chattypeteam.classList.toggle('tab-active', type === 'team'); dom.chatmessages.innerHTML = '<p class="text-center text-slate-400 m-auto">Загрузка сообщений...</p>'; }
        async function handleSendMessage(e) { e.preventDefault(); const text = dom.chatinput.value.trim(); if (!text || !currentUser) return; dom.chatinput.value = ''; const message = { text, senderUid: currentUser.uid, senderNickname: currentUser.nickname, senderTeam: currentUser.team, timestamp: serverTimestamp() }; try { const collectionName = currentChatType === 'global' ? 'global_chat' : `team_chats/${currentUser.team}/messages`; await addDoc(collection(db, collectionName), message); } catch (error) { console.error("Ошибка отправки сообщения: ", error); showAlert("Не удалось отправить сообщение."); } }
        function renderChatMessages(messages = []) { dom.chatmessages.innerHTML = ''; if (messages.length === 0) { dom.chatmessages.innerHTML = '<p class="text-center text-slate-400 m-auto">Сообщений пока нет.</p>'; return; } messages.forEach(msg => { const isOwnMessage = msg.senderUid === currentUser.uid; const messageDiv = document.createElement('div'); messageDiv.className = `flex flex-col mb-4 ${isOwnMessage ? 'items-end' : 'items-start'}`; messageDiv.innerHTML = `<div class="text-xs text-slate-400 px-1 ${isOwnMessage ? 'text-right' : 'text-left'}">${msg.senderNickname} <span class="text-slate-500">(${msg.senderTeam})</span></div><div class="p-3 rounded-lg max-w-xs md:max-w-md ${isOwnMessage ? 'bg-indigo-600' : 'bg-slate-600'}">${msg.text}</div>`; dom.chatmessages.appendChild(messageDiv); }); }
        function showLoadingScreen() { dom.loadingscreen.classList.remove('hidden'); dom.authscreen.classList.add('hidden'); dom.appcontainer.classList.add('hidden'); }
        function showAuthScreen() { dom.loadingscreen.classList.add('hidden'); dom.authscreen.classList.remove('hidden'); dom.appcontainer.classList.add('hidden'); renderAuthForm(); }
        function showAppContainer() { dom.loadingscreen.classList.add('hidden'); dom.authscreen.classList.add('hidden'); dom.appcontainer.classList.remove('hidden'); if (!document.querySelector('.tab-active')) switchTab('chat'); }
        dom.logoutbutton.addEventListener('click', () => signOut(auth));
        function formatTimeAgo(date) { if (!date) return 'недавно'; const now = new Date(); const seconds = Math.floor((now - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " г. назад"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " мес. назад"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " д. назад"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " ч. назад"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " мин. назад"; return "Только что"; }
        function updateRatingsUI(allUsers = [], currentUserId) { dom.personalratinglist.innerHTML = ''; allUsers.filter(u=>!u.isAdmin).forEach((user, index) => { const isCurrentUser = user.uid === currentUserId; dom.personalratinglist.innerHTML += `<li class="flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-indigo-600' : 'bg-slate-700'}"><div class="flex items-center"><span class="text-sm font-bold w-6 text-center mr-3">${index + 1}</span><div><p class="font-semibold">${user.nickname}</p><p class="text-xs text-slate-400">Команда "${user.team}"</p></div></div><span class="font-bold text-lg">${(user.totalPoints || 0).toLocaleString('ru-RU')}</span></li>`; }); const teamScores = allUsers.filter(u=>!u.isAdmin).reduce((acc, user) => { if(user.team) {acc[user.team] = (acc[user.team] || 0) + user.totalPoints;} return acc; }, {}); const sortedTeams = Object.entries(teamScores).map(([name, score]) => ({ name, score })).sort((a, b) => b.score - a.score); dom.teamratinglist.innerHTML = ''; sortedTeams.forEach((team, index) => { dom.teamratinglist.innerHTML += `<li class="bg-slate-700 p-4 rounded-lg flex items-center justify-between"><div class="flex items-center"><span class="text-lg font-bold w-8 text-center mr-4">${index + 1}</span><p class="font-bold text-xl">${team.name}</p></div><span class="font-bold text-2xl text-indigo-400">${team.score.toLocaleString('ru-RU')}</span></li>`; }); }
        function renderShopItems(shopItems = []) { if (!currentUser) return; dom.shopitemsgrid.innerHTML = ''; shopItems.forEach(item => { const canAfford = currentUser.balance >= item.price; const buttonClasses = canAfford ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-500 cursor-not-allowed'; dom.shopitemsgrid.innerHTML += `<div class="bg-slate-700/50 rounded-xl p-4 flex flex-col"><div class="w-full h-32 bg-slate-600 rounded-lg flex items-center justify-center mb-4"><ion-icon name="${item.icon || 'storefront-outline'}" class="text-5xl text-slate-400"></ion-icon></div><h3 class="font-bold text-lg text-white">${item.name}</h3><p class="text-sm text-slate-400 mb-4 flex-grow">${item.description}</p><div class="flex justify-between items-center"><span class="font-bold text-lg text-green-400">${item.price.toLocaleString()}</span><button class="buy-btn text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors ${buttonClasses}" data-item-id="${item.id}" ${!canAfford ? 'disabled' : ''}>Купить</button></div></div>`; }); document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', (e) => { const item = shopItems.find(i => i.id === e.target.dataset.itemId); if (item) openPurchaseConfirmModal(item); })); }
        function renderAdminPanel() { /* ... */ }
        function openPurchaseConfirmModal(item) { dom.purchaseconfirmtext.textContent = `Вы уверены, что хотите купить "${item.name}" за ${item.price.toLocaleString()} очков?`; dom.confirmpurchasebtn.onclick = () => handlePurchase(item); dom.purchaseconfirmmodal.classList.remove('hidden'); }
        function showAlert(message) { dom.alertmodaltext.textContent = message; dom.alertmodal.classList.remove('hidden'); }
        function showRankUpModal(newRank) { dom.newrankname.textContent = newRank; dom.rankupmodal.classList.remove('hidden'); }
        function showAchievementUnlockedModal(achievement) { dom.achievementname.textContent = achievement.name; dom.achievementdesc.textContent = achievement.description; dom.achievementunlockedmodal.classList.remove('hidden');}
        function switchTab(tab) { ['chat', 'feed', 'dashboard', 'ratings', 'shop', 'admin'].forEach(t => { dom[`${t}content`]?.classList.add('hidden'); dom[`tab${t}`]?.classList.remove('tab-active'); }); dom[`${tab}content`]?.classList.remove('hidden'); dom[`tab${tab}`]?.classList.add('tab-active'); }
        ['chat', 'feed', 'dashboard', 'ratings', 'shop', 'admin'].forEach(tabId => { if(dom[`tab${tabId}`]) dom[`tab${tabId}`].addEventListener('click', () => switchTab(tabId)) });
        dom.chattypeglobal.addEventListener('click', () => switchChatType('global'));
        dom.chattypeteam.addEventListener('click', () => switchChatType('team'));
        dom.chatform.addEventListener('submit', handleSendMessage);
        dom.addzalog.addEventListener('click', () => addPoints(100, 'zalogCount'));
        dom.addpochta.addEventListener('click', () => addPoints(20, 'pochtaCount'));
        dom.closerankmodal.addEventListener('click', () => dom.rankupmodal.classList.add('hidden'));
        dom.closeachievementmodal.addEventListener('click', () => dom.achievementunlockedmodal.classList.add('hidden'));
        dom.cancelpurchasebtn.addEventListener('click', () => dom.purchaseconfirmmodal.classList.add('hidden'));
        dom.closealertmodal.addEventListener('click', () => dom.alertmodal.classList.add('hidden'));

    </script>
    <!-- 
        ВАЖНО: ОБНОВИТЕ ПРАВИЛА FIREBASE
        Скопируйте и вставьте этот код во вкладку "Правила" (Rules) вашей Firestore Database.
    
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {

            match /users_public/{userId} {
              allow read;
              allow write: if request.auth.uid == userId;
            }

            match /users_private/{userId}/{document=**} {
              allow read, write: if request.auth.uid == userId;
            }

            match /shopItems/{itemId} {
              allow read;
              allow write: if get(/databases/$(database)/documents/users_public/$(request.auth.uid)).data.isAdmin == true;
            }

            match /eventLog/{logId} {
                allow read: if request.auth != null;
                allow create: if request.auth != null;
            }
            
            match /global_chat/{messageId} {
              allow read: if request.auth != null;
              allow create: if request.auth != null && request.resource.data.senderUid == request.auth.uid;
            }

            match /team_chats/{teamName}/messages/{messageId} {
              allow read, create: if request.auth != null && get(/databases/$(database)/documents/users_public/$(request.auth.uid)).data.team == teamName;
            }

            match /global/{state} {
                allow read;
                allow write: if get(/databases/$(database)/documents/users_public/$(request.auth.uid)).data.isAdmin == true;
            }
          }
        }
    -->
</body>
</html>
